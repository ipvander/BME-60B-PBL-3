% Ian Van Der Linde, Ryan Shabbak, Trevor Holmgren 
% 12/2/25
% Problem 2 â€“ This code loads MRI DICOM slices, normalizes their pixel 
% values, and displays the full stack as a montage.

clear all; close all; clc; % Clear everything

% Get a list of all DICOM files in the MRI Images folder
files = dir('MRI Images/*.dcm'); %Search all .dcm files inside folder

if isempty(files) %If no files are found
    error('No DICOM files found!'); %Stop the script with an error message
end

% Read the first file to get metadata
info = dicominfo(fullfile('MRI Images', ... %Load metadata for first slice
                          files(1).name));
nFrames = length(files); % Number of slices in the dataset
nRows   = info.Rows;    % Image height (number of rows)
nCols   = info.Columns; % Image width (number of columns)
nPlanes = info.SamplesPerPixel; % Number of color planes
% Preallocate
X = repmat(int16(0), [nRows, nCols, nPlanes, nFrames]); %Create 3D array to store all slices

minPixels = repmat(0, [1, nFrames]); %Vector of each slice's min pixel val
maxPixels = repmat(0, [1, nFrames]); %Vector of each slice's max pixel val

for i = 1:nFrames % Loop through all slices
    fname = fullfile('MRI Images', ... %Generate full path to i-th file
                     files(i).name);

    frame = dicomread(fname); % Read pixel data from the DICOM file
    info  = dicominfo(fname); % Read metadata from the same file

    X(:,:,1,i) = frame; % Store the slice in the 3D image volume

    minPixels(i) = min(frame(:)); % Store min pixel value for the slice
    maxPixels(i) = max(frame(:)); % Store max pixel value for the slice
end

% Compute absolute min and max pixel values
b = min(minPixels); % Absolute min pixel value
maxVal = max(maxPixels); % Absolute max pixel value

m = 2^16 - 1; % Max intensity for uint16
slope = m / (maxVal - b); % Scaling factor so data fills full uint16 range

% Apply the normalization to entire 3D volume
Y = imlincomb(slope, X, -(slope * b), ... %Linearly transform pixel values
              'uint16'); % Output as uint16 image

montage(Y); %Display all slices together in a montage
